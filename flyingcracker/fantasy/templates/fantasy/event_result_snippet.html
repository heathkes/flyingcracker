{% load user_time %}

{% with event=wrapper.event %}
{% with series=wrapper.series %}
<div class="section-header">
  <div class="fantasy-guess-deadline">
    {% if is_admin %}
    <input type="button" value="Edit {{ series.event_label|lower }}" onclick="location.href='{% url 'fantasy-event-edit' event.pk %}';" />
    {% endif %}
  </div>
  <div class="section-title">{{ event }}</div>
  {% if event.description %}
  <div class="section-tagline">{{ event.description }}</div>
  {% endif %}
</div>

{% if wrapper.user_guesses and not wrapper.result_list %}
<div class="section-header">
  <hr />
  <div class="fantasy-guess-deadline fantasy-form-help">
    {% with user|user_time:wrapper.guess_timestamp as timestamp %}
    submitted {{ timestamp|date:"D N d" }}<br />{{ timestamp|time:"f a" }} {% firstof user.get_profile.timezone event.timezone %}
    {% endwith %}
  </div>
  <h2>My Picks</h2>
  {% for guess in wrapper.user_guesses %}
  {{ guess.competitor }} ({{ guess.result }})<br />
  {% endfor %}
</div>
{% endif %}

{% if wrapper.result_list %}
<div class="section-header">
  <hr />
  <h2>{{ series.event_label|capfirst }} Result</h2>
  {% if wrapper.event_points_list and not event.result_locked %}(pending Series administrator approval){% endif %}
  <div id="result-list-container" class="fantasy-list-container">
    <table id="result-list-table" class="fantasy-list-table">
      <thead>
        <tr>
          <th>Place</th>
          <th>{{ series.competitor_label }}</th>
          <th>Fantasy<br />Points</th>
          <th>Picked By</th>
        </tr>
      </thead>
      <tbody>
{% for r in wrapper.result_list %}
        <tr>
          <td class="center">{{ r.result }}</td>
          <td>{{ r.competitor }}</td>
          <td class="center">{{ r.points_for_result }}</td>
          <td>{% with r.guessers as guessers %}{% if guessers %}{{ guessers|join:", " }}{% else %}------{% endif %}{% endwith %}</td>
        </tr>
{% endfor %}
      </tbody>
    </table>
    {% with wrapper.result_list.0.entered_by.username as entered_by %}
    {% if entered_by %}<div class="cbnewspubdate">[results kindly entered by {{ entered_by }}]</div>{% endif %}
    {% endwith %}
  </div>
</div>
{% endif %}

<div class="section-header">
  {% if is_admin or not event.result_locked and user.is_authenticated %}
  <input type="button" value="{% if result_list %}Edit{% else %}Enter{% endif %} {{ series.event_label|lower }} results" onclick="location.href='{% url 'fantasy-result-edit' event.pk %}';" />
  {% endif %}
</div>

{% if wrapper.bad_guess_list %}
<div class="section-header">
  <h2>{% if wrapper.result_list %}Out of the points{% else %}Guesses{% endif %}</h2>
  <div id="result-list-container" class="fantasy-list-container">
    <table id="guesser-list-table" class="fantasy-list-table">
      <thead>
        <tr>
          <th>Place</th>
          <th>{{ series.competitor_label }}</th>
          <th>Picked By</th>
        </tr>
      </thead>
      <tbody>
{% for g in wrapper.bad_guess_list %}
        <tr>
          <td class="center">{{ g.result }}</td>
          <td>{{ g.competitor }}</td>
          <td>{% with g.guessers as guessers %}{% if guessers %}{{ guessers|join:", " }}{% else %}------{% endif %}{% endwith %}</td>
        </tr>
{% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<div class="section-header">
{% if wrapper.event_points_list %}
  <h2>Fantasy Points awarded for this {{ series.event_label|capfirst }}</h2>
  {% if wrapper.event_points_list and not event.result_locked %}(pending Series administrator approval){% endif %}
  <div id="result-list-container" class="fantasy-list-container">
    <table id="event-points-list-table" class="fantasy-list-table">
      <thead>
        <tr>
          <th>Player</th>
          <th>Points</th>
        </tr>
      </thead>
      <tbody>
      {% for r in wrapper.event_points_list %}
        <tr>
          <td>{{ r.name }}{% if r.late %}&nbsp;*{% endif %}</td>
          <td class="center">{{ r.points }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    {% if wrapper.late_guesses %}
    <p>*&nbsp;<span class="late-entry">{{ series.late_entry_footnote }}</span></p>
    {% endif %}
  </div>
{% else %}
  <div  class="fantasy-list-container">
    {% for g in wrapper.guesses %}
    {% if forloop.first %}
    <table class="fantasy-list-table">
      <thead>
        <tr>
          <th>Player</th><th>Guess Time</th>
        </tr>
      </thead>
      <tbody>
    {% endif %}
        <tr>
          <td>{{ g.player }}</td>
          {% with user|user_time:g.timestamp as timestamp %}
          <td>{{ timestamp|date:"D N d" }} {{ timestamp|time:"f a" }} {% firstof user.get_profile.timezone event.timezone %}</td>
          {% endwith %}
        </tr>
    {% if forloop.last %}
      </tbody>
    </table>
    {% endif %}
    {% empty %}
    No guesses yet!
    {% endfor %}
  </div>
{% endif %}
</div>

{% if is_admin and not wrapper.result_list %}<br /><a href="{% url 'fantasy-event-delete' event.pk %}">Delete {{ series.event_label|lower }}</a>{% endif %}
{% endwith %}
{% endwith %}
